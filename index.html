<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="scripts/jquery-3.1.1.js"></script>
    <script src="scripts/d3.v3.min.js"></script>
    <title></title>
    <style>
        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }

        body {
            color: white;
            font-family: monospace;
            line-height: 1.5;
            background-color: #130C0E;
            padding: 20px;
        }

        button {
            font-size: 14px;
            background: #130C0E;
            color: #7AC143;
            border: none;
            outline: none;
            padding: 4px 8px;
            letter-spacing: 1px;
        }

            button:hover {
                background: #7AC143;
                color: #130C0E;
            }
    </style>
</head>
<body>

    <div>
        Open Mp3 <input id="audio_file" type="file" accept="audio/*" />

        Number of frequency lines <input type="range" id="FreqRange" min="1" max="200" value="5" />

        Horizontal Value Range  <input type="range" id="CountRange" value="90" min="5" max="2000" />
        <audio controls="controls" id="audioElement" />
    </div>


</body>

<script>
        audio_file.onchange = function () {
            var files = this.files;
            var file = URL.createObjectURL(files[0]);
            audioElement.src = file;
            //audioElement.play();
        };

        var FreqSize = 5;
        var frequencyData = new Uint8Array(FreqSize);
        var Count = 90;
        var AllSeries = [];
        for (i = 0; i < FreqSize; i++) {
            AllSeries.push(new Array(Count).fill(0));
        }

        $('#FreqRange').change(function (d) {
            FreqSize = $('#FreqRange').val();
            AllSeries = [];
            for (i = 0; i < FreqSize; i++) {
                AllSeries.push(new Array(Count).fill(0));
            }
            frequencyData = new Uint8Array(FreqSize);
            console.log(FreqSize);
           })

        $('#CountRange').change(function (d) {
            Count = $('#CountRange').val();
        })


        function GetFreqArray(index,arr)
        {
            var ret = [];

            for(var z = 0; z< arr.length; z++)
            {
                ret.push(arr[z][index]);
            }
            return ret;
        }

        (function () {
            'use strict';

            var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            var audioElement = document.getElementById('audioElement');
            var audioSrc = audioCtx.createMediaElementSource(audioElement);
            var analyser = audioCtx.createAnalyser();

            // bind our analyser to the media element source.
            audioSrc.connect(analyser);
            audioSrc.connect(audioCtx.destination);

            var Series1 = [];
            var Series2 = [];


            var truemax = 10;

            var svgHeight = 800,
                svgWidth = 1800;

            var svg = d3.select('body').append('svg')
                .attr({
                    height: svgHeight,
                    width: svgWidth
                });

            // continuously loop and update chart with frequency data.
            function renderChart() {


                requestAnimationFrame(renderChart);

                analyser.getByteFrequencyData(frequencyData);

                AllSeries.forEach(function (d, i) {
                    if(d.length > Count) {
                        d.shift();
                        d.shift();
                    }
                    if (d.length > Count) {
                        d.shift();
                    }
                    d.push(parseInt(frequencyData[i]));
                });

                //for (var i = 0; i < AllSeries.length; i++) {
                //    if (AllSeries[i].length > 500) {
                //        AllSeries[i].shift();
                //    }
                //}

                //for (var q = 0; q < AllSeries.length; q++)
                //{
                //    AllSeries[q].push(parseInt(frequencyData[q]));
                //}
                var newArray = AllSeries.slice();
                var max = d3.max(newArray, function (array) {
                    return d3.max(array);
                });

                if (truemax < max)
                {
                    truemax = max;
                }

                var x = d3.scale.linear()
                .domain([0, AllSeries[0].length])
                .range([0, svgWidth]);
                var y = d3.scale.linear()
                .domain([0, truemax])
                .range([svgHeight, 0]);




                // scale things to fit
                var radiusScale = d3.scale.linear()
                    .domain([0, max])
                    .range([0, svgHeight / 2 - 10]);

              //  console.log(AllSeries.length);

                var hueScale = d3.scale.linear()
                    .domain([0, AllSeries.length])
                    .range([0, 360]);
                var line = d3.svg.line()
                    .interpolate("basis")
                .x(function (d, i) {
                    return x(i);
                })
                .y(function (d) {
                    return y(d);
                });

                svg.selectAll("path").remove();

                AllSeries.forEach(function (d,i) {


                    svg.append("svg:path").attr("d", line(d)).attr("stroke", d3.hsl(hueScale(i), 1, 0.5))
                    .attr("fill", "none");
                });
            }

            renderChart();


        }());

</script>
</html>